<!DOCTYPE HTML>
<html
	class="js canvas canvastext geolocation rgba hsla no-multiplebgs borderimage borderradius boxshadow opacity no-cssanimations csscolumns no-cssgradients no-cssreflections csstransforms no-csstransforms3d no-csstransitions  video audio cufon-active fontface cufon-ready">
<head>
<meta charset="utf-8">
<script language="JavaScript"
	src="/ddz_server/r/js/jquery-1.11.1.min.js"></script>
</head>
<body>
	上家:
	<span id="lastUserId"></span>
	<br /> 下家:
	<span id="nextUserId"></span>
	<br />
	<textarea rows="20" cols="100" id="msg_text" readonly="readonly"></textarea>
	<br /> 本家：
	<span id="userId"></span>
	<br />
	<div id="pokers"></div>
	<br>
	<br>
	<button id="btn_start" onclick="start();">准备</button>
	<button id="btn_out" onclick="out();" style="display:none;">退出</button>
	<br>
	<br>
	<div id="selectLand" style="display:none;">
		<button id="btn_selectLand0" onclick="selectLand(0);">不叫</button>
		<button id="btn_selectLand1" onclick="selectLand(1);">1分</button>
		<button id="btn_selectLand2" onclick="selectLand(2);">2分</button>
		<button id="btn_selectLand3" onclick="selectLand(3);">3分</button>
	</div>
	<div id="out_div" style="display:none;">
		<button id="btn_out_poker" onclick="outPoker();">出牌</button>
		<button id="btn_not_out_poker" onclick="notOutPoker();">不出</button>
	</div>
	<script type="text/javascript">
		var userId = Math.ceil(Math.random() * 100);
		var lastUserId;//上家ID
		var nextUserId;//下家ID
		// 		var pokers;//手牌
		function start() {
			$("#btn_start").hide();
			$("#btn_out").show();
			var es = new EventSource("ddz/start?userId=" + userId);
			es.onmessage = function(event) {
				alert(event.data);
				// 				document.getElementById('push').innerHTML = event.data;
			};
			es.addEventListener('start', function(event) {//发牌成功后的回调函数
				$("#btn_out").hide();
				var d = jQuery.parseJSON(event.data);
				//三个玩家信息
				lastUserId = d.lastUserId;
				nextUserId = d.nextUserId;
				// 				pokers = d.pokers;
				$("#lastUserId").text(d.lastUserId);
				$("#nextUserId").text(d.nextUserId);
				$("#userId").text(d.userId);
				//alert(d.pokers);
				//显示牌
				showPokers(d.pokers);
				//显示信息
				msg("发牌完成");
				msg("下一个行动玩家是：" + d.actionPlayerId);
				if (d.actionPlayerId == d.userId) {//如果先手玩家是本人，则显示叫地主按钮
					showSelectLand(0);
				}
			});
			es.addEventListener('selectLand', function(event) {//叫地主后的回调函数
				var d = jQuery.parseJSON(event.data);
				if (d.status == 1) {
					// 显示信息
					msg("叫地主：玩家" + d.callPalyer + "叫了" + d.landv + "分");
					msg("下一个行动玩家是：" + d.actionPlayerId);
					if (d.actionPlayerId == userId) {//如果先手玩家是本人，则显示叫地主按钮
						if(d.initPoints==null)
							showSelectLand(0);
						else
							showSelectLand(d.initPoints);
					}
				} else if (d.status == 2) {
					// 显示信息
					msg("叫地主：玩家" + d.callPalyer + "叫了" + d.landv + "分");
					msg("游戏开始:" + d.landId + "是地主");
					msg("地主牌是：")
					msg("下一个行动玩家是：" + d.actionPlayerId);
					//显示三位玩家的身份
					if (d.landId == userId) {
						$("#userId").append("地主");
						$("#lastUserId").append("农民");
						$("#nextUserId").append("农民");
					} else if (d.landId == lastUserId) {
						$("#userId").append("农民");
						$("#lastUserId").append("地主");
						$("#nextUserId").append("农民");
					} else if (d.landId == nextUserId) {
						$("#userId").append("农民");
						$("#lastUserId").append("农民");
						$("#nextUserId").append("地主");
					}
					if (d.actionPlayerId == userId) {//如果先手玩家是本人，则显示出牌按钮，附加地主牌
						appendPokers(d.lands);
						showOutDiv2();
					}
				}
			});
			es.addEventListener('outPoker', function(event) {//出牌后的回调函数
				var d = jQuery.parseJSON(event.data);
				// 显示信息
				msg("出牌："+d.outPokerMan+"出了"+d.outPoker);
				msg("下一个行动玩家是：" + d.actionPlayerId);
				//如果行动人为本人，则显示出牌按钮 
				if (d.actionPlayerId == userId) {//如果先手玩家是本人，则显示出牌按钮，附加地主牌
						showOutDiv();
					}
				
			});
		}
		//显示叫分按钮
		function showSelectLand(v) {
			$("#selectLand").hide();
			$("#btn_selectLand0").hide();
			$("#btn_selectLand1").hide();
			$("#btn_selectLand2").hide();
			$("#btn_selectLand3").hide();
			if(v>=3||v<0)
				return;
			$("#selectLand").show();
			$("#btn_selectLand0").show();
			if (1 > v)
				$("#btn_selectLand1").show();
			if (2 > v)
				$("#btn_selectLand2").show();
			if (3 > v)
				$("#btn_selectLand3").show();

		}
		//显示出牌按钮和不出按钮
		function showOutDiv() {
			$("#out_div").show();
			$("#btn_out_poker").show();
			$("#btn_not_out_poker").show();
		}
		//只显示出牌按钮
		function showOutDiv2() {
			$("#out_div").show();
			$("#btn_out_poker").show();
			$("#btn_not_out_poker").hide();
		}
		//出牌
		function outPoker(){
			var pokers = [];
			//获取原有手牌
			$('input[name="pokers"]:checked').each(function() {
				pokers.push($(this).val());//将选中的值添加到数组chk_value中      
				
				
			});
			if(pokers.length<=0){
				alert("请选择要出的牌");
				return;
			}
			$.ajax({
				url : "/ddz_server/ddz/outPoker?userId=" + userId + "&pokers="
						+ pokers,
				type : "post",
				success : function() {
					$("#out_div").hide();
					for (var i = 0; i < pokers.length; i++) {
						$("#poker"+pokers[i]+"").remove();// 删除手牌中出掉的牌
					}
				}
			});
		}
		function notOutPoker(){
		
		}
		//叫地主
		function selectLand(v) {
			$.ajax({
				url : "/ddz_server/ddz/selectLand?userId=" + userId + "&landv="
						+ v,
				type : "post",
				success : function() {
					$("#selectLand").hide();
				}
			});
		}
		//退出
		function out() {
			$.ajax({
				url : "/ddz_server/ddz/outTable?userId=" + userId,
				type : "post",
				success : function() {
					msg("退出");
					$("#btn_out").hide();
					$("#btn_start").show();
				}
			});
		}
		// 		显示信息
		function msg(str) {
			$("#msg_text").val($("#msg_text").val() + str + "\n");
		}
		//展示手牌
		function showPokers(pokers) {
			$("#pokers").html("");
			pokers.forEach(function(id) {
				var p = idToPoker(id);
				$("#pokers").append(
						'<span id = "poker'+id+'"><input type="checkbox" name="pokers" value = "'+id+'">'
								+ p.color + p.name+'</span>');
			});
		}
		//附加手牌（地主牌）
		function appendPokers(pokers) {
			var handle = [];
			//获取原有手牌
			$('input[name="pokers"]').each(function() {
				handle.push($(this).val());//将选中的值添加到数组chk_value中      
			});
// 			alert(handle);
			//添加地主牌到手牌
			pokers.forEach(function(id) {
				handle.push(id);
			});
// 			alert(handle);
			//手牌排序
			handle.sort(function(a, b) {
				return b - a
			});
// 			alert(handle);
			showPokers(handle);
		}
		var names = [ "", "", "", "3", "4", "5", "6", "7", "8", "9", "10", "J",
				"Q", "K", "A", "2", "小王", "大王" ];
		var colors = [ "黑", "红", "梅", "方" ];
		function idToPoker(id) {
			var s = {
				id : null,
				name : null,
				color : null
			};
			s.id = id;
			s.name = names[Math.floor(id / 10)];
			s.color = colors[id % 10];
			return s;
		}
		// 		var x = idToPoker(31);
		// 		alert(x.color +x.name);
	</script>
</body>
</html>

